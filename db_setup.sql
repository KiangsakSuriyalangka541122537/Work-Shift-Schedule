-- คัดลอกโค้ดนี้ไปวางใน SQL Editor ของ Supabase และกด RUN

-- 1. สร้าง Schema "Work-Shift-Schedule" (ถ้ายังไม่มี)
CREATE SCHEMA IF NOT EXISTS "Work-Shift-Schedule";
GRANT USAGE ON SCHEMA "Work-Shift-Schedule" TO anon, authenticated, service_role;

-- 2. สร้างตาราง Users ใน Schema นี้ (จำเป็นสำหรับระบบ Login)
CREATE TABLE IF NOT EXISTS "Work-Shift-Schedule".users (
  id bigint generated by default as identity primary key,
  username text not null unique,
  password text not null,
  name text not null,
  role text default 'user',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. จัดการตาราง "Table-kik" (สำหรับเก็บข้อมูลเวร)
-- หมายเหตุ: เราจะลบตารางเดิมถ้ามีอยู่ เพื่อสร้างใหม่ให้มีโครงสร้างคอลัมน์ที่ถูกต้อง (ID เป็น Text)
DROP TABLE IF EXISTS "Work-Shift-Schedule"."Table-kik";

CREATE TABLE "Work-Shift-Schedule"."Table-kik" (
  id text primary key, -- ใช้ Text เพราะ App สร้าง ID แบบผสม (staffId-date-type)
  staff_id text not null,
  date text not null,
  shift_type text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. ให้สิทธิ์ตารางทั้งหมด
GRANT ALL ON ALL TABLES IN SCHEMA "Work-Shift-Schedule" TO anon, authenticated, service_role;
GRANT ALL ON ALL SEQUENCES IN SCHEMA "Work-Shift-Schedule" TO anon, authenticated, service_role;

-- 5. เพิ่มข้อมูลผู้ใช้งานเริ่มต้น (ถ้ายังไม่มี)
INSERT INTO "Work-Shift-Schedule".users (username, password, name, role) VALUES
('tor', 'tor', 'พี่ต่อ', 'user'),
('kik', 'kik', 'พี่กิ๊ก', 'user'),
('jhim', 'jhim', 'พี่จิ๋ม', 'user'),
('pan', 'pan', 'น้องปาน', 'user'),
('top', 'top', 'พี่ท๊อป', 'user'),
('team', 'team', 'พี่ทีม', 'user'),
('admin', '1234', 'Admin', 'admin')
ON CONFLICT (username) DO NOTHING;

-- 6. เปิดใช้งาน Row Level Security (RLS)
ALTER TABLE "Work-Shift-Schedule".users ENABLE ROW LEVEL SECURITY;
ALTER TABLE "Work-Shift-Schedule"."Table-kik" ENABLE ROW LEVEL SECURITY;

-- 7. สร้าง Policies เพื่ออนุญาตให้เข้าถึงข้อมูล
-- Users Policies
CREATE POLICY "Allow read access for all" ON "Work-Shift-Schedule".users FOR SELECT USING (true);
CREATE POLICY "Allow insert access for all" ON "Work-Shift-Schedule".users FOR INSERT WITH CHECK (true);
CREATE POLICY "Allow update access for all" ON "Work-Shift-Schedule".users FOR UPDATE USING (true);
CREATE POLICY "Allow delete access for all" ON "Work-Shift-Schedule".users FOR DELETE USING (true);

-- Table-kik Policies
CREATE POLICY "Allow read access for all" ON "Work-Shift-Schedule"."Table-kik" FOR SELECT USING (true);
CREATE POLICY "Allow insert access for all" ON "Work-Shift-Schedule"."Table-kik" FOR INSERT WITH CHECK (true);
CREATE POLICY "Allow update access for all" ON "Work-Shift-Schedule"."Table-kik" FOR UPDATE USING (true);
CREATE POLICY "Allow delete access for all" ON "Work-Shift-Schedule"."Table-kik" FOR DELETE USING (true);

-- *** อย่าลืมไปที่ Settings -> API -> Exposed Schemas และเพิ่ม "Work-Shift-Schedule" ด้วยครับ ***
