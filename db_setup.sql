-- คัดลอกโค้ดนี้ไปวางใน SQL Editor ของ Supabase และกด RUN
-- Script นี้จะปรับปรุงโครงสร้าง Database ให้รองรับฟีเจอร์ใหม่ (Snapshot ตารางเวร)

-- 1. สร้างตาราง Table-kik (ตารางเวร)
CREATE TABLE IF NOT EXISTS public."Table-kik" (
  id text primary key,
  staff_id text not null,
  date text not null,
  shift_type text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. สร้างตาราง monthly_roster_status (สถานะการประกาศ)
CREATE TABLE IF NOT EXISTS public.monthly_roster_status (
    month_key text primary key, 
    is_published boolean default false,
    published_by text,
    updated_at timestamp with time zone default timezone('utc'::text, now())
);

-- [สำคัญ] คำสั่งนี้จะเพิ่มคอลัมน์ original_assignments ให้กับตารางเดิมที่มีอยู่แล้ว
-- แก้ปัญหา Error: Could not find the 'original_assignments' column
ALTER TABLE public.monthly_roster_status ADD COLUMN IF NOT EXISTS original_assignments jsonb;

-- 3. สร้างตาราง users-table-kik (ตารางผู้ใช้งาน)
CREATE TABLE IF NOT EXISTS public."users-table-kik" (
  id bigint generated by default as identity primary key,
  username text not null unique,
  password text not null,
  name text not null,
  role text default 'user',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. สร้างตาราง shift_logs (เก็บประวัติการแลกเวร)
CREATE TABLE IF NOT EXISTS public.shift_logs (
  id bigint generated by default as identity primary key,
  month_key text not null,
  target_date text not null, 
  message text not null, 
  action_type text not null, 
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 5. ให้สิทธิ์การใช้งาน (Permissions)
GRANT ALL ON ALL TABLES IN SCHEMA public TO anon, authenticated, service_role;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO anon, authenticated, service_role;

-- 6. เพิ่มข้อมูลผู้ใช้งานเริ่มต้น (ถ้ายังไม่มี)
INSERT INTO public."users-table-kik" (username, password, name, role) VALUES
('tor', 'tor', 'พี่ต่อ', 'user'),
('kik', 'kik', 'พี่กิ๊ก', 'user'),
('jhim', 'jhim', 'พี่จิ๋ม', 'user'),
('pan', 'pan', 'น้องปาน', 'user'),
('top', 'top', 'พี่ท๊อป', 'user'),
('team', 'team', 'พี่ทีม', 'user'),
('admin', '1234', 'Admin', 'admin')
ON CONFLICT (username) DO NOTHING;

-- 7. ตั้งค่า Row Level Security (RLS)
ALTER TABLE public."users-table-kik" ENABLE ROW LEVEL SECURITY;
ALTER TABLE public."Table-kik" ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.monthly_roster_status ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.shift_logs ENABLE ROW LEVEL SECURITY;

-- 8. ล้าง Policies เก่าและสร้างใหม่
DROP POLICY IF EXISTS "Allow all access" ON public.monthly_roster_status;
DROP POLICY IF EXISTS "Allow all access" ON public."Table-kik";
DROP POLICY IF EXISTS "Allow all access" ON public."users-table-kik";
DROP POLICY IF EXISTS "Allow all access" ON public.shift_logs;

CREATE POLICY "Allow all access" ON public."users-table-kik" FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Allow all access" ON public.monthly_roster_status FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Allow all access" ON public."Table-kik" FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Allow all access" ON public.shift_logs FOR ALL USING (true) WITH CHECK (true);

-- [สำคัญ] สั่งให้ Supabase โหลด Schema Cache ใหม่ทันที
NOTIFY pgrst, 'reload schema';