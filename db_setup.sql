-- คัดลอกโค้ดนี้ไปวางใน SQL Editor ของ Supabase และกด RUN
-- Script นี้จะสร้างตารางใน Schema "public" ซึ่งเป็นค่าเริ่มต้น (แก้ไขปัญหา Invalid Schema)

-- 1. สร้างตาราง Users (ใน public)
CREATE TABLE IF NOT EXISTS public.users (
  id bigint generated by default as identity primary key,
  username text not null unique,
  password text not null,
  name text not null,
  role text default 'user',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. สร้างตาราง Table-kik (ใน public)
CREATE TABLE IF NOT EXISTS public."Table-kik" (
  id text primary key,
  staff_id text not null,
  date text not null,
  shift_type text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. สร้างตาราง monthly_roster_status (เก็บสถานะการประกาศตารางเวรรายเดือน)
CREATE TABLE IF NOT EXISTS public.monthly_roster_status (
    month_key text primary key, -- รูปแบบ 'YYYY-MM'
    is_published boolean default false,
    published_by text,
    updated_at timestamp with time zone default timezone('utc'::text, now())
);

-- 4. ให้สิทธิ์การใช้งาน
GRANT ALL ON ALL TABLES IN SCHEMA public TO anon, authenticated, service_role;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO anon, authenticated, service_role;

-- 5. เพิ่มข้อมูลผู้ใช้งานเริ่มต้น
INSERT INTO public.users (username, password, name, role) VALUES
('tor', 'tor', 'พี่ต่อ', 'user'),
('kik', 'kik', 'พี่กิ๊ก', 'user'),
('jhim', 'jhim', 'พี่จิ๋ม', 'user'),
('pan', 'pan', 'น้องปาน', 'user'),
('top', 'top', 'พี่ท๊อป', 'user'),
('team', 'team', 'พี่ทีม', 'user'),
('admin', '1234', 'Admin', 'admin')
ON CONFLICT (username) DO NOTHING;

-- 6. เปิดการใช้งาน Row Level Security (RLS)
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public."Table-kik" ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.monthly_roster_status ENABLE ROW LEVEL SECURITY;

-- 7. ล้าง Policies เก่าทิ้งทั้งหมดป้องกัน Error
DROP POLICY IF EXISTS "Allow read access for all" ON public.users;
DROP POLICY IF EXISTS "Allow insert access for all" ON public.users;
DROP POLICY IF EXISTS "Allow update access for all" ON public.users;
DROP POLICY IF EXISTS "Allow delete access for all" ON public.users;

DROP POLICY IF EXISTS "Allow read access for all" ON public."Table-kik";
DROP POLICY IF EXISTS "Allow insert access for all" ON public."Table-kik";
DROP POLICY IF EXISTS "Allow update access for all" ON public."Table-kik";
DROP POLICY IF EXISTS "Allow delete access for all" ON public."Table-kik";

DROP POLICY IF EXISTS "Allow all access" ON public.monthly_roster_status;

-- 8. สร้าง Policies ใหม่ (อนุญาตให้ทุกคนอ่าน/เขียนได้เพื่อความสะดวก)
-- Users Policies
CREATE POLICY "Allow read access for all" ON public.users FOR SELECT USING (true);
CREATE POLICY "Allow insert access for all" ON public.users FOR INSERT WITH CHECK (true);
CREATE POLICY "Allow update access for all" ON public.users FOR UPDATE USING (true);
CREATE POLICY "Allow delete access for all" ON public.users FOR DELETE USING (true);

-- Table-kik Policies
CREATE POLICY "Allow read access for all" ON public."Table-kik" FOR SELECT USING (true);
CREATE POLICY "Allow insert access for all" ON public."Table-kik" FOR INSERT WITH CHECK (true);
CREATE POLICY "Allow update access for all" ON public."Table-kik" FOR UPDATE USING (true);
CREATE POLICY "Allow delete access for all" ON public."Table-kik" FOR DELETE USING (true);

-- Monthly Status Policies
CREATE POLICY "Allow all access" ON public.monthly_roster_status FOR ALL USING (true) WITH CHECK (true);